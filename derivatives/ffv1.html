<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="lyx.css" type="text/css" />
  <script type="text/javascript">/*<![CDATA[*/
  /*
  March 19, 2004 MathHTML (c) Peter Jipsen http://www.chapman.edu/~jipsen
  Released under the GNU General Public License version 2 or later.
  See the GNU General Public License (at http://www.gnu.org/copyleft/gpl.html)
  for more details.
  */
  
  function convertMath(node) {// for Gecko
    if (node.nodeType==1) {
      var newnode =
        document.createElementNS("http://www.w3.org/1998/Math/MathML",
          node.nodeName.toLowerCase());
      for(var i=0; i < node.attributes.length; i++)
        newnode.setAttribute(node.attributes[i].nodeName,
          node.attributes[i].value);
      for (var i=0; i<node.childNodes.length; i++) {
        var st = node.childNodes[i].nodeValue;
        if (st==null || st.slice(0,1)!=" " && st.slice(0,1)!="\n")
          newnode.appendChild(convertMath(node.childNodes[i]));
      }
      return newnode;
    }
    else return node;
  }
  
  function convert() {
    var mmlnode = document.getElementsByTagName("math");
    var st,str,node,newnode;
    for (var i=0; i<mmlnode.length; i++)
      if (document.createElementNS!=null)
        mmlnode[i].parentNode.replaceChild(convertMath(mmlnode[i]),mmlnode[i]);
      else { // convert for IE
        str = "";
        node = mmlnode[i];
        while (node.nodeName!="/MATH") {
          st = node.nodeName.toLowerCase();
          if (st=="#text") str += node.nodeValue;
          else {
            str += (st.slice(0,1)=="/" ? "</m:"+st.slice(1) : "<m:"+st);
            if (st.slice(0,1)!="/")
               for(var j=0; j < node.attributes.length; j++)
                 if (node.attributes[j].value!="italic" &&
                   node.attributes[j].value!="" &&
                   node.attributes[j].value!="inherit" &&
                   node.attributes[j].value!=undefined)
                   str += " "+node.attributes[j].nodeName+"="+
                       "\""+node.attributes[j].value+"\"";
            str += ">";
          }
          node = node.nextSibling;
          node.parentNode.removeChild(node.previousSibling);
        }
        str += "</m:math>";
        newnode = document.createElement("span");
        node.parentNode.replaceChild(newnode,node);
        newnode.innerHTML = str;
      }
  }
  
  if (document.createElementNS==null) {
    document.write("<object id=\"mathplayer\"\
    classid=\"clsid:32F66A20-7614-11D4-BD11-00104BD3F987\"></object>");
    document.write("<?import namespace=\"m\" implementation=\"#mathplayer\"?>");
  }
  if(typeof window.addEventListener != 'undefined'){
    window.addEventListener('load', convert, false);
  }
  if(typeof window.attachEvent != 'undefined') {
    window.attachEvent('onload', convert);
  }
  /*]]>*/
  </script>
</head>
<body>
<h1>
FFV1 Video Codec Specification
</h1>
<h2>
by Michael Niedermayer <script type="text/javascript">
<!--
h='&#x67;&#x6d;&#120;&#46;&#x61;&#116;';a='&#64;';n='&#x6d;&#x69;&#x63;&#104;&#x61;&#x65;&#108;&#110;&#x69;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'" clas'+'s="em' + 'ail">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>&#x6d;&#x69;&#x63;&#104;&#x61;&#x65;&#108;&#110;&#x69;&#32;&#x61;&#116;&#32;&#x67;&#x6d;&#120;&#32;&#100;&#x6f;&#116;&#32;&#x61;&#116;</noscript>
</h2>
<!-- toc -->
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#terms-and-definitions">Terms and Definitions</a></li>
<li><a href="#terms">Terms</a></li>
<li><a href="#definitions">Definitions</a></li>
<li><a href="#conventions">Conventions</a></li>
<li><a href="#arithmetic-operators">Arithmetic operators</a></li>
<li><a href="#assignment-operators">Assignment operators</a></li>
<li><a href="#comparison-operators">Comparison operators</a></li>
<li><a href="#order-of-operation-precedence">Order of operation precedence</a></li>
<li><a href="#range">Range</a></li>
<li><a href="#bitstream-functions">Bitstream functions</a></li>
<li><a href="#general-description">General Description</a></li>
<li><a href="#border">Border</a></li>
<li><a href="#median-predictor">Median predictor</a></li>
<li><a href="#context">Context</a></li>
<li><a href="#quantization">Quantization</a></li>
<li><a href="#colorspace">Colorspace</a>
<ul>
<li><a href="#jpeg2000-rct">JPEG2000-RCT</a></li>
</ul></li>
<li><a href="#coding-of-the-sample-difference">Coding of the sample difference</a>
<ul>
<li><a href="#range-coding-mode">Range coding mode</a></li>
<li><a href="#huffman-coding-mode">Huffman coding mode</a></li>
</ul></li>
<li><a href="#bitstream">Bitstream</a></li>
<li><a href="#configuration-record">Configuration Record</a>
<ul>
<li><a href="#in-avi-file-format">In AVI File Format</a></li>
<li><a href="#in-isoiec-14496-12-mp4-file-format">In ISO/IEC 14496-12 (MP4 File Format)</a></li>
<li><a href="#in-nut-file-format">In NUT File Format</a></li>
</ul></li>
<li><a href="#frame">Frame</a></li>
<li><a href="#slice">Slice</a></li>
<li><a href="#slice-header">Slice Header</a></li>
<li><a href="#parameters">Parameters</a></li>
<li><a href="#quantization-tables">Quantization Tables</a>
<ul>
<li><a href="#restrictions">Restrictions</a></li>
</ul></li>
<li><a href="#changelog">Changelog</a></li>
<li><a href="#todo">ToDo</a></li>
<li><a href="#bibliography">Bibliography</a></li>
<li><a href="#references">References</a></li>
<li><a href="#copyright">Copyright</a></li>
</ul>
<!-- toc stop -->
<h1 id="introduction"><span class="header-section-number">1</span> Introduction</h1>
<p>The FFV1 video codec is a simple and efficient lossless intra-frame only codec.</p>
<p>The latest version of this document is available at <a href="https://raw.github.com/FFmpeg/FFV1/master/ffv1.md" class="uri">https://raw.github.com/FFmpeg/FFV1/master/ffv1.md</a></p>
<p>This document assumes familiarity with mathematical and coding concepts such as Range coding and YCbCr colorspaces.</p>
<h1 id="terms-and-definitions"><span class="header-section-number">2</span> Terms and Definitions</h1>
<h2 id="terms"><span class="header-section-number">2.1</span> Terms</h2>
<p>The key words MUST, MUST NOT, SHOULD, and SHOULD NOT in this document are to be interpreted as described in <a href="#references">RFC 2119.</a></p>
<p>For reference, below is an excerpt of RFC 2119:</p>
<table>
<colgroup>
<col width="15%" />
<col width="84%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left">&quot;MUST&quot;</td>
<td align="left">means that the definition is an absolute requirement of the specification.</td>
</tr>
<tr class="even">
<td align="left">&quot;MUST NOT&quot;</td>
<td align="left">means that the definition is an absolute prohibition of the specification.</td>
</tr>
<tr class="odd">
<td align="left">“SHOULD”</td>
<td align="left">means that there may exist valid reasons in particular circumstances to ignore a particular item, but the full implications must be understood and carefully weighed before choosing a different course.</td>
</tr>
<tr class="even">
<td align="left">“SHOULD NOT”</td>
<td align="left">means that there may exist valid reasons in particular circumstances when the particular behavior is acceptable or even useful, but the full implications should be understood and the case carefully weighed before implementing any behavior described with this label.</td>
</tr>
</tbody>
</table>
<h2 id="definitions"><span class="header-section-number">2.2</span> Definitions</h2>
<table>
<colgroup>
<col width="6%" />
<col width="93%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left">ESC</td>
<td align="left">Escape symbol to indicate that the symbol to be stored is too large for normal storage and a different method is used to store it.</td>
</tr>
<tr class="even">
<td align="left">MSB</td>
<td align="left">Most significant bit, the bit that can cause the largest change in magnitude of the symbol.</td>
</tr>
<tr class="odd">
<td align="left">RCT</td>
<td align="left">Reversible Color Transform, a near linear, exactly reversible integer transform that converts between RGB and YCbCr representations of a sample.</td>
</tr>
<tr class="even">
<td align="left">VLC</td>
<td align="left">Variable length code.</td>
</tr>
</tbody>
</table>
<h1 id="conventions"><span class="header-section-number">3</span> Conventions</h1>
<p>Note: the operators and the order of precedence are the same as used in the C programming language <a href="#references">ISO/IEC 9899</a>.</p>
<h2 id="arithmetic-operators"><span class="header-section-number">3.1</span> Arithmetic operators</h2>
<p><strong>a + b</strong> means a plus b.</p>
<p><strong>a - b</strong> means a minus b.</p>
<p><strong>-a</strong> means negation of a.</p>
<p><strong>a * b</strong> means a multiplied by b.</p>
<p><strong>a / b</strong> means a divided by b with truncation of the result toward zero.</p>
<p><strong>a % b</strong> means remainder of a divided by b.</p>
<p><strong>a &amp; b</strong> means bit-wise “and” of a and b.</p>
<p><strong>a | b</strong> means bit-wise “or” of a and b.</p>
<p><strong>a &gt;&gt; b</strong> means arithmetic righ shift of two’s complement integer representation of a by b binary digits.</p>
<p><strong>a &lt;&lt; b</strong> means arithmetic left shift of two’s complement integer representation of a by b binary digits.</p>
<h2 id="assignment-operators"><span class="header-section-number">3.2</span> Assignment operators</h2>
<p><strong>a = b</strong> means a is assigned b.</p>
<p><strong>a++</strong> is equivalent to a = a + 1.</p>
<p><strong>a–</strong> is equivalent to a = a - 1.</p>
<p><strong>a += b</strong> is equivalent to a = a + b.</p>
<p><strong>a -= b</strong> is equivalent to a = a - b.</p>
<h2 id="comparison-operators"><span class="header-section-number">3.3</span> Comparison operators</h2>
<p><strong>a &gt; b</strong> means a greater than b.</p>
<p><strong>a &gt;= b</strong> means a greater than or equal to b.</p>
<p><strong>a &lt; b</strong> means a less than b.</p>
<p><strong>a &lt;= b</strong> means a less than or equal b.</p>
<p><strong>a == b</strong> means a equal to b.</p>
<p><strong>a != b</strong> means a not equalto b.</p>
<p><strong>a &amp;&amp; b</strong> means boolean logical “and” of a and b.</p>
<p><strong>a || b</strong> means boolean logical “or” of a and b.</p>
<p><strong>!a</strong> means boolean logical “not”.</p>
<p><strong>a ? b : c</strong> means b if a is true otherwise c.</p>
<h2 id="order-of-operation-precedence"><span class="header-section-number">3.4</span> Order of operation precedence</h2>
<p>When order of precedence is not indicated explicitly by use of parentheses, operations are evaluated in the following order (from top to bottom, operations of same precedence being evaluated from left to right):</p>
<table>
<tbody>
<tr class="odd">
<td align="center">a++, a–</td>
</tr>
<tr class="even">
<td align="center">!a, -a</td>
</tr>
<tr class="odd">
<td align="center">a * b, a / b, a % b</td>
</tr>
<tr class="even">
<td align="center">a + b, a - b</td>
</tr>
<tr class="odd">
<td align="center">a &lt;&lt; b, a &gt;&gt; b</td>
</tr>
<tr class="even">
<td align="center">a &lt; b, a &lt;= b, a &gt; b, a &gt;= b</td>
</tr>
<tr class="odd">
<td align="center">a == b, a != b</td>
</tr>
<tr class="even">
<td align="center">a &amp; b</td>
</tr>
<tr class="odd">
<td align="center">a</td>
</tr>
<tr class="even">
<td align="center">a &amp;&amp; b</td>
</tr>
<tr class="odd">
<td align="center">a</td>
</tr>
<tr class="even">
<td align="center">a ? b : c</td>
</tr>
<tr class="odd">
<td align="center">a = b, a += b, a -= b</td>
</tr>
</tbody>
</table>
<h2 id="range"><span class="header-section-number">3.5</span> Range</h2>
<p><strong>a...b</strong> means any value starting from a to b, inclusive.</p>
<h2 id="bitstream-functions"><span class="header-section-number">3.6</span> Bitstream functions</h2>
<p><strong>remaing_bits_in_bitstream( )</strong> means the count of remaining bits after the current position in the bitstream. It is computed from the NumBytes value multiplied by 8 minus the count of bits already read by the bitstream parser.</p>
<h1 id="general-description"><span class="header-section-number">4</span> General Description</h1>
<p>Each frame is split in 1 to 4 planes (Y, Cb, Cr, Alpha). In the case of the normal YCbCr colorspace the Y plane is coded first followed by the Cb and Cr planes, if an Alpha/transparency plane exists, it is coded last. In the case of the JPEG2000-RCT colorspace the lines are interleaved to improve caching efficiency since it is most likely that the RCT will immediately be converted to RGB during decoding; the interleaved coding order is also Y,Cb,Cr,Alpha.</p>
<p>Samples within a plane are coded in raster scan order (left-&gt;right, top-&gt;bottom). Each sample is predicted by the median predictor from samples in the same plane and the difference is stored see <a href="#coding-of-the-sample-difference">Coding of the Sample Difference</a>.</p>
<h2 id="border"><span class="header-section-number">4.1</span> Border</h2>
<p>For the purpose of the predictior and context, samples above the coded slice are assumed to be 0; samples to the right of the coded slice are identical to the closest left sample; samples to the left of the coded slice are identical to the top right sample (if there is one), otherwise 0.</p>
<table>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">0</td>
<td align="left"></td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left"></td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">0</td>
<td align="left">0</td>
<td align="left"></td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left"></td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td align="left">0</td>
<td align="left">0</td>
<td align="left"></td>
<td align="left">a</td>
<td align="left">b</td>
<td align="left">c</td>
<td align="left"></td>
<td align="left">c</td>
</tr>
<tr class="even">
<td align="left">0</td>
<td align="left">a</td>
<td align="left"></td>
<td align="left">d</td>
<td align="left"></td>
<td align="left">e</td>
<td align="left"></td>
<td align="left">e</td>
</tr>
<tr class="odd">
<td align="left">0</td>
<td align="left">d</td>
<td align="left"></td>
<td align="left">f</td>
<td align="left">g</td>
<td align="left">h</td>
<td align="left"></td>
<td align="left">h</td>
</tr>
</tbody>
</table>
<h2 id="median-predictor"><span class="header-section-number">4.2</span> Median predictor</h2>
<p>median(left, top, left + top - diag)</p>
<p>left, top, diag are the left, top and left-top samples</p>
<p>Note, this is also used in <a href="#references">JPEG-LS and HuffYuv</a>.</p>
<h2 id="context"><span class="header-section-number">4.3</span> Context</h2>
<table>
<tbody>
<tr class="odd">
<td align="left"></td>
<td align="left"></td>
<td align="left">T</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left">tl</td>
<td align="left">t</td>
<td align="left">tr</td>
</tr>
<tr class="odd">
<td align="left">L</td>
<td align="left">l</td>
<td align="left">X</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>The quantized sample differences L-l, l-tl, tl-t, t-T, t-tr are used as context:</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mo>=</mo><msub><mi>Q</mi><mn>0</mn></msub><mo stretchy="false" form="prefix">[</mo><mi>l</mi><mo>−</mo><mi>t</mi><mi>l</mi><mo stretchy="false" form="postfix">]</mo><mo>+</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>Q</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="false" form="prefix">(</mo><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false" form="prefix">[</mo><mi>t</mi><mi>l</mi><mo>−</mo><mi>t</mi><mo stretchy="false" form="postfix">]</mo><mo>+</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="false" form="prefix">(</mo><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false" form="prefix">[</mo><mi>t</mi><mo>−</mo><mi>t</mi><mi>r</mi><mo stretchy="false" form="postfix">]</mo><mo>+</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="false" form="prefix">(</mo><msub><mi>Q</mi><mn>3</mn></msub><mo stretchy="false" form="prefix">[</mo><mi>L</mi><mo>−</mo><mi>l</mi><mo stretchy="false" form="postfix">]</mo><mo>+</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>Q</mi><mn>3</mn></msub><mo stretchy="true" form="postfix">|</mo></mrow><msub><mi>Q</mi><mn>4</mn></msub><mo stretchy="false" form="prefix">[</mo><mi>T</mi><mo>−</mo><mi>t</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">context=Q_{0}[l-tl]+\left|Q_{0}\right|(Q_{1}[tl-t]+\left|Q_{1}\right|(Q_{2}[t-tr]+\left|Q_{2}\right|(Q_{3}[L-l]+\left|Q_{3}\right|Q_{4}[T-t])))</annotation></semantics></math></p>
<p>If the context is smaller than 0 then -context is used and the difference between the sample and its predicted value is encoded with a flipped sign.</p>
<h2 id="quantization"><span class="header-section-number">4.4</span> Quantization</h2>
<p>There are 5 quantization tables for the 5 sample differences, both the number of quantization steps and their distribution are stored in the bitstream. Each quantization table has exactly 256 entries, and the 8 least significant bits of the sample difference are used as index:</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">[</mo><mi>a</mi><mo>−</mo><mi>b</mi><mo stretchy="false" form="postfix">]</mo><mo>=</mo><mi>T</mi><mi>a</mi><mi>b</mi><mi>l</mi><msub><mi>e</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">[</mo><mo stretchy="false" form="prefix">(</mo><mi>a</mi><mo>−</mo><mi>b</mi><mo stretchy="false" form="postfix">)</mo><mo>&amp;</mo><mn>255</mn><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">Q_{i}[a-b]=Table_{i}[(a-b)\&amp;255]</annotation></semantics></math></p>
<h2 id="colorspace"><span class="header-section-number">4.5</span> Colorspace</h2>
<h3 id="jpeg2000-rct"><span class="header-section-number">4.5.1</span> JPEG2000-RCT</h3>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>b</mi><mo>=</mo><mi>b</mi><mo>−</mo><mi>g</mi></mrow><annotation encoding="application/x-tex">Cb=b-g</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>r</mi><mo>=</mo><mi>r</mi><mo>−</mo><mi>g</mi></mrow><annotation encoding="application/x-tex">Cr=r-g</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>g</mi><mo>+</mo><mo stretchy="false" form="prefix">(</mo><mi>C</mi><mi>b</mi><mo>+</mo><mi>C</mi><mi>r</mi><mo stretchy="false" form="postfix">)</mo><mo>&gt;</mo><mo>&gt;</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">Y=g+(Cb+Cr)&gt;&gt;2</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>=</mo><mi>Y</mi><mo>−</mo><mo stretchy="false" form="prefix">(</mo><mi>C</mi><mi>b</mi><mo>+</mo><mi>C</mi><mi>r</mi><mo stretchy="false" form="postfix">)</mo><mo>&gt;</mo><mo>&gt;</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">g=Y-(Cb+Cr)&gt;&gt;2</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mi>C</mi><mi>r</mi><mo>+</mo><mi>g</mi></mrow><annotation encoding="application/x-tex">r=Cr+g</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mi>C</mi><mi>b</mi><mo>+</mo><mi>g</mi></mrow><annotation encoding="application/x-tex">b=Cb+g</annotation></semantics></math></p>
<p><a href="#references">JPEG2000</a></p>
<h2 id="coding-of-the-sample-difference"><span class="header-section-number">4.6</span> Coding of the sample difference</h2>
<p>Instead of coding the n+1 bits of the sample difference with Huffman-, or Range coding (or n+2 bits, in the case of RCT), only the n (or n+1) least significant bits are used, since this is sufficient to recover the original sample. In the equation below, the term “bits” represents bits_per_raw_sample+1 for RCT or bits_per_raw_sample otherwise:</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>r</mi><mo accent="false">_</mo><mi>i</mi><mi>n</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mo accent="false">_</mo><mi>d</mi><mi>i</mi><mi>f</mi><mi>f</mi><mi>e</mi><mi>r</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>+</mo><msup><mn>2</mn><mrow><mi>b</mi><mi>i</mi><mi>t</mi><mi>s</mi><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>&amp;</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mn>2</mn><mrow><mi>b</mi><mi>i</mi><mi>t</mi><mi>s</mi></mrow></msup><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><msup><mn>2</mn><mrow><mi>b</mi><mi>i</mi><mi>t</mi><mi>s</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">coder\_input=\left[\left(sample\_difference+2^{bits-1}\right)\&amp;\left(2^{bits}-1\right)\right]-2^{bits-1}</annotation></semantics></math></p>
<h3 id="range-coding-mode"><span class="header-section-number">4.6.1</span> Range coding mode</h3>
<p>Early experimental versions of FFV1 used the CABAC Arithmetic coder from <a href="#references">H.264</a> but due to the uncertain patent/royality situation, as well as its slightly worse performance, CABAC was replaced by a range coder based on an algorithm defined by <em>G. Nigel N. Martin</em> in 1979 <a href="#references">RangeCoder</a>.</p>
<h4 id="range-binary-values"><span class="header-section-number">4.6.1.1</span> Range binary values</h4>
<p>To encode binary digits efficiently a range coder is used. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>C</mi><mi>i</mi></msub><annotation encoding="application/x-tex">C_{i}</annotation></semantics></math> is the i-th Context. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mi>i</mi></msub><annotation encoding="application/x-tex">B_{i}</annotation></semantics></math> is the i-th byte of the bytestream. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mi>i</mi></msub><annotation encoding="application/x-tex">b_{i}</annotation></semantics></math> is the i-th range coded binary value, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>S</mi><mrow><mn>0</mn><mo>,</mo><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">S_{0,i}</annotation></semantics></math> is the i-th initial state, which is 128. The length of the bytestream encoding n binary symbols is <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>j</mi><mi>n</mi></msub><annotation encoding="application/x-tex">j_{n}</annotation></semantics></math> bytes.</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>i</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">⌊</mo><mfrac><mrow><msub><mi>R</mi><mi>i</mi></msub><msub><mi>S</mi><mrow><mi>i</mi><mo>,</mo><msub><mi>C</mi><mi>i</mi></msub></mrow></msub></mrow><msup><mn>2</mn><mn>8</mn></msup></mfrac><mo stretchy="true" form="postfix">⌋</mo></mrow></mrow><annotation encoding="application/x-tex">r_{i}=\left\lfloor \frac{R_{i}S_{i,C_{i}}}{2^{8}}\right\rfloor</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="center"><msub><mi>S</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn><mo>,</mo><msub><mi>C</mi><mi>i</mi></msub></mrow></msub><mo>=</mo><mi>z</mi><mi>e</mi><mi>r</mi><mi>o</mi><mo accent="false">_</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><msub><mi>e</mi><msub><mi>S</mi><mrow><mi>i</mi><mo>,</mo><msub><mi>C</mi><mi>i</mi></msub></mrow></msub></msub></mtd><mtd columnalign="center"><mo>∧</mo></mtd><mtd columnalign="center"><mi>l</mi><msub><mrow></mrow><mi>i</mi></msub><mo>=</mo><msub><mi>L</mi><mi>i</mi></msub></mtd><mtd columnalign="center"><mo>∧</mo></mtd><mtd columnalign="center"><msub><mi>t</mi><mi>i</mi></msub><mo>=</mo><msub><mi>R</mi><mi>i</mi></msub><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub></mtd><mtd columnalign="center"><mo accent="false">⇐</mo></mtd><mtd columnalign="center"><msub><mi>b</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mtd><mtd columnalign="center"><mo accent="false">⇔</mo></mtd><mtd columnalign="center"><msub><mi>L</mi><mi>i</mi></msub><mo>&lt;</mo><msub><mi>R</mi><mi>i</mi></msub><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub></mtd></mtr><mtr><mtd columnalign="center"><msub><mi>S</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn><mo>,</mo><msub><mi>C</mi><mi>i</mi></msub></mrow></msub><mo>=</mo><mi>o</mi><mi>n</mi><mi>e</mi><mo accent="false">_</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><msub><mi>e</mi><msub><mi>S</mi><mrow><mi>i</mi><mo>,</mo><msub><mi>C</mi><mi>i</mi></msub></mrow></msub></msub></mtd><mtd columnalign="center"><mo>∧</mo></mtd><mtd columnalign="center"><msub><mi>l</mi><mi>i</mi></msub><mo>=</mo><msub><mi>L</mi><mi>i</mi></msub><mo>−</mo><msub><mi>R</mi><mi>i</mi></msub><mo>+</mo><msub><mi>r</mi><mi>i</mi></msub></mtd><mtd columnalign="center"><mo>∧</mo></mtd><mtd columnalign="center"><msub><mi>t</mi><mi>i</mi></msub><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub></mtd><mtd columnalign="center"><mo accent="false">⇐</mo></mtd><mtd columnalign="center"><msub><mi>b</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mtd><mtd columnalign="center"><mo accent="false">⇔</mo></mtd><mtd columnalign="center"><msub><mi>L</mi><mi>i</mi></msub><mo>≥</mo><msub><mi>R</mi><mi>i</mi></msub><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{array}{ccccccccc} S_{i+1,C_{i}}=zero\_state_{S_{i,C_{i}}} &amp; \wedge &amp; l{}_{i}=L_{i} &amp; \wedge &amp; t_{i}=R_{i}-r_{i} &amp; \Longleftarrow &amp; b_{i}=0 &amp; \Longleftrightarrow &amp; L_{i}&lt;R_{i}-r_{i}\\ S_{i+1,C_{i}}=one\_state_{S_{i,C_{i}}} &amp; \wedge &amp; l_{i}=L_{i}-R_{i}+r_{i} &amp; \wedge &amp; t_{i}=r_{i} &amp; \Longleftarrow &amp; b_{i}=1 &amp; \Longleftrightarrow &amp; L_{i}\geq R_{i}-r_{i} \end{array}</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="center"><msub><mi>S</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn><mo>,</mo><mi>k</mi></mrow></msub><mo>=</mo><msub><mi>S</mi><mrow><mi>i</mi><mo>,</mo><mi>k</mi></mrow></msub></mtd><mtd columnalign="center"><mo accent="false">⇐</mo></mtd><mtd columnalign="center"><msub><mi>C</mi><mi>i</mi></msub><mo>≠</mo><mi>k</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{array}{ccc} S_{i+1,k}=S_{i,k} &amp; \Longleftarrow &amp; C_{i}\neq k \end{array}</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="center"><msub><mi>R</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msup><mn>2</mn><mn>8</mn></msup><msub><mi>t</mi><mi>i</mi></msub></mtd><mtd columnalign="center"><mo>∧</mo></mtd><mtd columnalign="center"><msub><mi>L</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msup><mn>2</mn><mn>8</mn></msup><msub><mi>l</mi><mi>i</mi></msub><mo>+</mo><msub><mi>B</mi><msub><mi>j</mi><mi>i</mi></msub></msub></mtd><mtd columnalign="center"><mo>∧</mo></mtd><mtd columnalign="center"><msub><mi>j</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>j</mi><mi>i</mi></msub><mo>+</mo><mn>1</mn></mtd><mtd columnalign="center"><mo accent="false">⇐</mo></mtd><mtd columnalign="center"><msub><mi>t</mi><mi>i</mi></msub><mo>&lt;</mo><msup><mn>2</mn><mn>8</mn></msup></mtd></mtr><mtr><mtd columnalign="center"><msub><mi>R</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>t</mi><mi>i</mi></msub></mtd><mtd columnalign="center"><mo>∧</mo></mtd><mtd columnalign="center"><msub><mi>L</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>l</mi><mi>i</mi></msub></mtd><mtd columnalign="center"><mo>∧</mo></mtd><mtd columnalign="center"><msub><mi>j</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>j</mi><mi>i</mi></msub></mtd><mtd columnalign="center"><mo accent="false">⇐</mo></mtd><mtd columnalign="center"><msub><mi>t</mi><mi>i</mi></msub><mo>≥</mo><msup><mn>2</mn><mn>8</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{array}{ccccccc} R_{i+1}=2^{8}t_{i} &amp; \wedge &amp; L_{i+1}=2^{8}l_{i}+B_{j_{i}} &amp; \wedge &amp; j_{i+1}=j_{i}+1 &amp; \Longleftarrow &amp; t_{i}&lt;2^{8}\\ R_{i+1}=t_{i} &amp; \wedge &amp; L_{i+1}=l_{i} &amp; \wedge &amp; j_{i+1}=j_{i} &amp; \Longleftarrow &amp; t_{i}\geq2^{8} \end{array}</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mn>0</mn></msub><mo>=</mo><mn>65280</mn></mrow><annotation encoding="application/x-tex">R_{0}=65280</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mn>0</mn></msub><mo>=</mo><msup><mn>2</mn><mn>8</mn></msup><msub><mi>B</mi><mn>0</mn></msub><mo>+</mo><msub><mi>B</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">L_{0}=2^{8}B_{0}+B_{1}</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>j</mi><mn>0</mn></msub><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">j_{0}=2</annotation></semantics></math></p>
<h4 id="range-non-binary-values"><span class="header-section-number">4.6.1.2</span> Range non binary values</h4>
<p>To encode scalar integers it would be possible to encode each bit separately and use the past bits as context. However that would mean 255 contexts per 8-bit symbol which is not only a waste of memory but also requires more past data to reach a reasonably good estimate of the probabilities. Alternatively assuming a Laplacian distribution and only dealing with its variance and mean (as in Huffman coding) would also be possible, however, for maximum flexibility and simplicity, the chosen method uses a single symbol to encode if a number is 0 and if not encodes the number using its exponent, mantissa and sign. The exact contexts used are best described by the following code, followed by some comments.</p>
<pre><code>void put_symbol(RangeCoder *c, uint8_t *state, int v, int is_signed) {
    int i;
    put_rac(c, state+0, !v);
    if (v) {
        int a= ABS(v);
        int e= log2(a); 

        for (i=0; i&lt;e; i++)

            put_rac(c, state+1+MIN(i,9), 1);  //1..10

        put_rac(c, state+1+MIN(i,9), 0);
        for (i=e-1; i&gt;=0; i--)
            put_rac(c, state+22+MIN(i,9), (a&gt;&gt;i)&amp;1); //22..31

        if (is_signed)
            put_rac(c, state+11 + MIN(e, 10), v &lt; 0); //11..21
    }
}</code></pre>
<h4 id="initial-values-for-the-context-model"><span class="header-section-number">4.6.1.3</span> Initial values for the context model</h4>
<p>At keyframes all range coder state variables are set to their initial state.</p>
<h4 id="state-transition-table"><span class="header-section-number">4.6.1.4</span> State transition table<br /></h4>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>n</mi><mi>e</mi><mo accent="false">_</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><msub><mi>e</mi><mi>i</mi></msub><mo>=</mo><mi>d</mi><mi>e</mi><mi>f</mi><mi>a</mi><mi>u</mi><mi>l</mi><mi>t</mi><mo accent="false">_</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi><mo accent="false">_</mo><mi>t</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>o</mi><msub><mi>n</mi><mi>i</mi></msub><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi><mo accent="false">_</mo><mi>t</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo accent="false">_</mo><mi>d</mi><mi>e</mi><mi>l</mi><mi>t</mi><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">one\_state_{i}=default\_state\_transition_{i}+state\_transition\_delta_{i}</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mi>e</mi><mi>r</mi><mi>o</mi><mo accent="false">_</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><msub><mi>e</mi><mi>i</mi></msub><mo>=</mo><mn>256</mn><mo>−</mo><mi>o</mi><mi>n</mi><mi>e</mi><mo accent="false">_</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><msub><mi>e</mi><mrow><mn>256</mn><mo>−</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">zero\_state_{i}=256-one\_state_{256-i}</annotation></semantics></math></p>
<h4 id="default_state_transition"><span class="header-section-number">4.6.1.5</span> default_state_transition</h4>
<pre><code>  0,  0,  0,  0,  0,  0,  0,  0, 20, 21, 22, 23, 24, 25, 26, 27,

 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 37, 38, 39, 40, 41, 42,

 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 56, 57,

 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73,

 74, 75, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88,

 89, 90, 91, 92, 93, 94, 94, 95, 96, 97, 98, 99,100,101,102,103,

104,105,106,107,108,109,110,111,112,113,114,114,115,116,117,118,

119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,133,

134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,

150,151,152,152,153,154,155,156,157,158,159,160,161,162,163,164,

165,166,167,168,169,170,171,171,172,173,174,175,176,177,178,179,

180,181,182,183,184,185,186,187,188,189,190,190,191,192,194,194,

195,196,197,198,199,200,201,202,202,204,205,206,207,208,209,209,

210,211,212,213,215,215,216,217,218,219,220,220,222,223,224,225,

226,227,227,229,229,230,231,232,234,234,235,236,237,238,239,240,

241,242,243,244,245,246,247,248,248,  0,  0,  0,  0,  0,  0,  0,</code></pre>
<h4 id="alternative-state-transition-table"><span class="header-section-number">4.6.1.6</span> alternative state transition table</h4>
<p>The alternative state transition table has been build using iterative minimization of frame sizes and generally performs better than the default. To use it, the coder_type has to be set to 2 and the difference to the default has to be stored in the parameters. The reference implemenation of FFV1 in FFmpeg uses this table by default at the time of this writing when Range coding is used.</p>
<pre><code>  0, 10, 10, 10, 10, 16, 16, 16, 28, 16, 16, 29, 42, 49, 20, 49,

 59, 25, 26, 26, 27, 31, 33, 33, 33, 34, 34, 37, 67, 38, 39, 39,

 40, 40, 41, 79, 43, 44, 45, 45, 48, 48, 64, 50, 51, 52, 88, 52,

 53, 74, 55, 57, 58, 58, 74, 60,101, 61, 62, 84, 66, 66, 68, 69,

 87, 82, 71, 97, 73, 73, 82, 75,111, 77, 94, 78, 87, 81, 83, 97,

 85, 83, 94, 86, 99, 89, 90, 99,111, 92, 93,134, 95, 98,105, 98,

105,110,102,108,102,118,103,106,106,113,109,112,114,112,116,125,

115,116,117,117,126,119,125,121,121,123,145,124,126,131,127,129,

165,130,132,138,133,135,145,136,137,139,146,141,143,142,144,148,

147,155,151,149,151,150,152,157,153,154,156,168,158,162,161,160,

172,163,169,164,166,184,167,170,177,174,171,173,182,176,180,178,

175,189,179,181,186,183,192,185,200,187,191,188,190,197,193,196,

197,194,195,196,198,202,199,201,210,203,207,204,205,206,208,214,

209,211,221,212,213,215,224,216,217,218,219,220,222,228,223,225,

226,224,227,229,240,230,231,232,233,234,235,236,238,239,237,242,

241,243,242,244,245,246,247,248,249,250,251,252,252,253,254,255,</code></pre>
<h3 id="huffman-coding-mode"><span class="header-section-number">4.6.2</span> Huffman coding mode</h3>
<p>This coding mode uses golomb rice codes. The VLC code is split into 2 parts, the prefix stores the most significant bits, the suffix stores the k least significant bits or stores the whole number in the ESC case. The end of the bitstream (of the frame) is filled with 0-bits so that the bitstream contains a multiple of 8 bits.</p>
<h4 id="prefix"><span class="header-section-number">4.6.2.1</span> Prefix</h4>
<table>
<thead>
<tr class="header">
<th align="left">bits</th>
<th align="left">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">01</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">...</td>
<td align="left">...</td>
</tr>
<tr class="even">
<td align="left">0000 0000 0001</td>
<td align="left">11</td>
</tr>
<tr class="odd">
<td align="left">0000 0000 0000</td>
<td align="left">ESC</td>
</tr>
</tbody>
</table>
<h4 id="suffix"><span class="header-section-number">4.6.2.2</span> Suffix</h4>
<table>
<tbody>
<tr class="odd">
<td align="left">non ESC</td>
<td align="left">the k least significant bits MSB first</td>
</tr>
<tr class="even">
<td align="left">ESC</td>
<td align="left">the value - 11, in MSB first order, ESC may only be used if the value cannot be coded as non ESC</td>
</tr>
</tbody>
</table>
<h4 id="examples"><span class="header-section-number">4.6.2.3</span> Examples</h4>
<table>
<thead>
<tr class="header">
<th align="center">k</th>
<th align="center">bits</th>
<th align="center">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">0</td>
<td align="center">001</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">1 00</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">1 10</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">01 01</td>
<td align="center">5</td>
</tr>
<tr class="even">
<td align="center">any</td>
<td align="center">000000000000 10000000</td>
<td align="center">139</td>
</tr>
</tbody>
</table>
<h4 id="run-mode"><span class="header-section-number">4.6.2.4</span> Run mode</h4>
<p>Run mode is entered when the context is 0, and left as soon as a non-0 difference is found, the level is identical to the predicted one, the run and the first different level is coded.</p>
<h4 id="run-length-coding"><span class="header-section-number">4.6.2.5</span> Run length coding</h4>
<p>The run value is encoded in 2 parts, the prefix part stores the more significant part of the run as well as adjusting the run_index which determines the number of bits in the less significant part of the run. The 2nd part of the value stores the less significant part of the run as it is. The run_index is reset for each plane and slice to 0.</p>
<pre><code>log2_run[41]={JPEGLS.
 0, 0, 0, 0, 1, 1, 1, 1,
 2, 2, 2, 2, 3, 3, 3, 3,
 4, 4, 5, 5, 6, 6, 7, 7,
 8, 9,10,11,12,13,14,15,
16,17,18,19,20,21,22,23,
24,
};

if (run_count == 0 &amp;&amp; run_mode == 1) {
    if (get_bits1()) {
        run_count = 1 &lt;&lt; log2_run[run_index];
        if (x + run_count &lt;= w)
            run_index++;
    } else {
        if (log2_run[run_index])
            run_count = get_bits(log2_run[run_index]);
        else
            run_count = 0;
        if (run_index)
            run_index--;
        run_mode = 2;
    }
}</code></pre>
<p><a href="#references">JPEGLS</a></p>
<h4 id="level-coding"><span class="header-section-number">4.6.2.6</span> Level coding</h4>
<p>Level coding is identical to the normal difference coding with the exception that the 0 value is removed as it cannot occur:</p>
<pre><code>    if(diff&gt;0) diff--;
    encode(diff);</code></pre>
<p>Note, this is different from JPEG-LS, which doesn’t use prediction in run mode and uses a different encoding and context model for the last difference On a small set of test samples the use of prediction slightly improved the compression rate.</p>
<h1 id="bitstream"><span class="header-section-number">5</span> Bitstream</h1>
<table>
<tbody>
<tr class="odd">
<td align="left">u(n)</td>
<td align="left">unsigned big endian integer using n bits</td>
</tr>
<tr class="even">
<td align="left">sg</td>
<td align="left">Golomb Rice coded signed scalar symbol coded with the method described in <a href="#huffman-coding-mode">Huffman Coding Mode</a></td>
</tr>
<tr class="odd">
<td align="left">br</td>
<td align="left">Range coded boolean (1-bit) symbol with the method described in <a href="#range-binary-values">Range binary values</a></td>
</tr>
<tr class="even">
<td align="left">ur</td>
<td align="left">Range coded unsigned scalar symbol coded with the method described in <a href="#range-non-binary-values">Range non binary values</a></td>
</tr>
<tr class="odd">
<td align="left">sr</td>
<td align="left">Range coded signed scalar symbol coded with the method described in <a href="#range-non-binary-values">Range non binary values</a></td>
</tr>
</tbody>
</table>
<p>The same context which is initialized to 128 is used for all fields in the header.</p>
<p>Default values at the decoder initialization phase:</p>
<p><strong>ConfigurationRecordIsPresent</strong> is set to 0.</p>
<h2 id="configuration-record"><span class="header-section-number">5.1</span> Configuration Record</h2>
<p>In the case of a bitstream with version &gt;= 2, a configuration record is stored in the the underlying container, at the track header level. It contains the parameters used for all frames. The size of the configuration record, NumBytes, is supplied by the underlying container.</p>
<table>
<thead>
<tr class="header">
<th align="left">ConfigurationRecord( NumBytes ) {</th>
<th align="right"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">ConfigurationRecordIsPresent = 1</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">Parameters( )</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">while( remaining_bits_in_bitstream( ) &gt; 32)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">    reserved_for_future_use</td>
<td align="right">u(1)</td>
</tr>
<tr class="odd">
<td align="left">configuration_record_crc_parity</td>
<td align="right">u(32)</td>
</tr>
<tr class="even">
<td align="left">}</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<p><strong>reserved_for_future_use</strong> has semantics that are reserved for future use.<br /> Encoders conforming to this version of this specification SHALL NOT write this value.<br /> Decoders conforming to this version of this specification SHALL ignore its value.</p>
<p><strong>configuration_record_crc_parity</strong> 32 bits that are choosen so that the configuration record as a whole has a crc remainder of 0.<br /> This is equivalent to storing the crc remainder in the 32-bit parity.<br /> The CRC generator polynom used is the standard IEEE CRC polynom (0x104C11DB7) with initial value 0.</p>
<p>This configuration record can be placed in any file format supporting configuration records, fitting as much as possible with how the file format uses to store configuration records. The configuration record storage place and NumBytes are currently defined and supported by this version of this specification for the following container formats:</p>
<h3 id="in-avi-file-format"><span class="header-section-number">5.1.1</span> In AVI File Format</h3>
<p>The Configuration Record extends the stream format chunk (``AVI ``, “hdlr”, “strl”, “strf”) with the ConfigurationRecord bistream.<br />See <a href="#references">AVI</a> for more information about chunks.</p>
<p><strong>NumBytes</strong> is defined as the size, in bytes, of the strf chunk indicated in the chunk header minus the size of the stream format structure.</p>
<h3 id="in-isoiec-14496-12-mp4-file-format"><span class="header-section-number">5.1.2</span> In ISO/IEC 14496-12 (MP4 File Format)</h3>
<p>The Configuration Record extends the sample description box (“moov”, “trak”, “mdia”, “minf”, “stbl”, “stsd”) with a “glbl” box which contains the ConfigurationRecord bitstream.<br />See <a href="#references">ISO14496_12</a> for more information about boxes.</p>
<p>**NumBytes* is defined as the size, in bytes, of the “glbl” box indicated in the box header minus the size of the box header.</p>
<h3 id="in-nut-file-format"><span class="header-section-number">5.1.3</span> In NUT File Format</h3>
<p>The codec_specific_data element (in “stream_header” packet) contains the ConfigurationRecord bitstream.<br />See <a href="#references">NUT</a> for more information about elements.</p>
<p><strong>NumBytes</strong> is defined as the size, in bytes, of the codec_specific_data element as indicated in the “length” field of codec_specific_data</p>
<h2 id="frame"><span class="header-section-number">5.2</span> Frame</h2>
<table>
<tbody>
<tr class="odd">
<td align="left">Frame( ) {</td>
<td align="right">type</td>
</tr>
<tr class="even">
<td align="left">    keyframe</td>
<td align="right">br</td>
</tr>
<tr class="odd">
<td align="left">    if( keyframe &amp;&amp; !ConfigurationRecordIsPresent)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">         Parameters( )</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">    for( i = 0; i &lt; slice_count; i++ )</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">        Slice( i )</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">}</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<h2 id="slice"><span class="header-section-number">5.3</span> Slice</h2>
<table>
<tbody>
<tr class="odd">
<td align="left">Slice( i ) {</td>
<td align="right">type</td>
</tr>
<tr class="even">
<td align="left">    if( version &gt; 2 )</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">        SliceHeader( i )</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">    if( colorspace_type == 0) {</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">        for( p = 0; p &lt; primary_color_count; p++ ) {</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">            Plane( p )</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">    } else if( colorspace_type == 1) {</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">        for( y = 0; y &lt; height; y++ )</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">            for( p = 0; p &lt; primary_color_count; p++ ) {</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">                Line( p, y )</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">    }</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">    if( i</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">        slice_size</td>
<td align="right">u(24)</td>
</tr>
<tr class="even">
<td align="left">    if( ec ) {</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">        error_status</td>
<td align="right">u(8)</td>
</tr>
<tr class="even">
<td align="left">        slice_crc_parity</td>
<td align="right">u(32)</td>
</tr>
<tr class="odd">
<td align="left">    }</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">}</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<p><strong>primary_color_count</strong> is defined as 1 + ( chroma_planes ? 2 : 0 ) + ( alpha_plane ? 1 : 0 ).</p>
<p><strong>slice_size</strong> indicates the size of the slice in bytes.<br /> Note: this allows finding the start of slices before previous slices have been fully decoded. And allows this way parallel decoding as well as error resilience.</p>
<p><strong>error_status</strong> specifies the error status.</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">error status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">no error</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">slice contains a correctable error</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">slice contains a uncorrectable error</td>
</tr>
<tr class="even">
<td align="left">Other</td>
<td align="left">reserved for future use</td>
</tr>
</tbody>
</table>
<p><strong>slice_crc_parity</strong> 32 bits that are choosen so that the slice as a whole has a crc remainder of 0.<br /> This is equivalent to storing the crc remainder in the 32-bit parity.<br /> The CRC generator polynom used is the standard IEEE CRC polynom (0x104C11DB7) with initial value 0.</p>
<h2 id="slice-header"><span class="header-section-number">5.4</span> Slice Header</h2>
<table>
<thead>
<tr class="header">
<th align="left">SliceHeader( i ) {</th>
<th align="right">type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">   slice_x</td>
<td align="right">ur</td>
</tr>
<tr class="even">
<td align="left">   slice_y</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">   slice_width - 1</td>
<td align="right">ur</td>
</tr>
<tr class="even">
<td align="left">   slice_height - 1</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">   for( j = 0; j &lt; quant_table_index_count; j++)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">       quant_table_index [ i ][ j ]</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">   picture_structure</td>
<td align="right">ur</td>
</tr>
<tr class="even">
<td align="left">   sar_num</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">   sar_den</td>
<td align="right">ur</td>
</tr>
<tr class="even">
<td align="left">   if( version &gt; 3 ) {</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">       reset_contexts</td>
<td align="right">br</td>
</tr>
<tr class="even">
<td align="left">       slice_coding_mode</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">   }</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">}</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<p><strong>slice_x</strong> indicates the x position on the slice raster formed by num_h_slices.<br /> Inferred to be 0 if not present.</p>
<p><strong>slice_y</strong> indicates the y position on the slice raster formed by num_v_slices.<br /> Inferred to be 0 if not present.</p>
<p><strong>slice_width</strong> indicates the width on the slice raster.<br /> Inferred to be 1 if not present.</p>
<p><strong>slice_height</strong> indicates the height on the slice raster.<br /> Inferred to be 1 if not present.</p>
<p><strong>quant_table_index_count</strong> is defined as 1 + ( ( chroma_planes || version &lt; 4 ) ? 1 : 0 ) + ( alpha_plane ? 1 : 0 ).</p>
<p><strong>quant_table_index</strong> indicates the index to select the quantization table set and the initial states for the slice.<br /> Inferred to be 0 if not present.</p>
<p><strong>picture_structure</strong> specifies the picture structure.<br /> Inferred to be 0 if not present.</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">picure structure used</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">unknown</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">top field first</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">bottom field first</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">progressive</td>
</tr>
<tr class="odd">
<td align="left">Other</td>
<td align="left">reserved for future use</td>
</tr>
</tbody>
</table>
<p><strong>sar_num</strong> specifies the sample aspect ratio numerator.<br /> Inferred to be 0 if not present.<br /> MUST be 0 if sample aspect ratio is unknown.</p>
<p><strong>sar_den</strong> specifies the sample aspect ratio numerator.<br /> Inferred to be 0 if not present.<br /> MUST be 0 if sample aspect ratio is unknown.</p>
<p><strong>reset_contexts</strong> indicates if slice contexts must be reset.<br /> Inferred to be 0 if not present.</p>
<p><strong>slice_coding_mode</strong> indicates the slice coding mode.<br /> Inferred to be 0 if not present.</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">slice coding mode</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">normal Range Coding or VLC</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">raw PCM</td>
</tr>
<tr class="odd">
<td align="left">Other</td>
<td align="left">reserved for future use</td>
</tr>
</tbody>
</table>
<h2 id="parameters"><span class="header-section-number">5.5</span> Parameters</h2>
<table>
<thead>
<tr class="header">
<th align="left">Parameters( ) {</th>
<th align="right">type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">   version</td>
<td align="right">ur</td>
</tr>
<tr class="even">
<td align="left">   if( version &gt; 2 )</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">       micro_version</td>
<td align="right">ur</td>
</tr>
<tr class="even">
<td align="left">   coder_type</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">   if( coder_type &gt; 1 )</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">       for( i = 1; i &lt; 256; i++ )</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">           state_transition_delta[ i ]</td>
<td align="right">sr</td>
</tr>
<tr class="even">
<td align="left">   colorspace_type</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">   if( version &gt; 0 )</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">       bits_per_raw_sample</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">   chroma_planes</td>
<td align="right">br</td>
</tr>
<tr class="even">
<td align="left">   log2( h_chroma_subsample )</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">   log2( v_chroma_subsample )</td>
<td align="right">ur</td>
</tr>
<tr class="even">
<td align="left">   alpha_plane</td>
<td align="right">br</td>
</tr>
<tr class="odd">
<td align="left">   if ( version &gt; 1 ) {</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">       num_h_slices - 1</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">       num_v_slices - 1</td>
<td align="right">ur</td>
</tr>
<tr class="even">
<td align="left">       quant_table_count</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">   }</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">   for( i = 0; i &lt; quant_table_count; i++ )</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">       QuantizationTable( i )</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">   if ( version &gt; 1 ) {</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">       for( i = 0; i &lt; quant_table_count; i++ ) {</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">           states_coded</td>
<td align="right">br</td>
</tr>
<tr class="odd">
<td align="left">           if( states_coded )</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">               for( j = 0; j &lt; context_count[ i ]; j++ )</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">                   for( k = 0; k &lt; CONTEXT_SIZE; k++ )</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">                       initial_state_delta[ i ][ j ][ k ]</td>
<td align="right">sr</td>
</tr>
<tr class="odd">
<td align="left">       }</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">       ec</td>
<td align="right">ur</td>
</tr>
<tr class="odd">
<td align="left">       intra</td>
<td align="right">ur</td>
</tr>
<tr class="even">
<td align="left">   }</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">}</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<p><strong>version</strong> specifies the version of the bitstream.<br /> Each version is incompatible with others versions: decoders SHOULD reject a file due to unknown version.<br /> Decoders SHOULD reject a file with version &lt; 2 &amp;&amp; ConfigurationRecordIsPresent == 1.<br /> Decoders SHOULD reject a file with version &gt;= 2 &amp;&amp; ConfigurationRecordIsPresent == 0.</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">version</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">FFV1 version 0</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">FFV1 version 1</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">reserved*</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">FFV1 version 3</td>
</tr>
<tr class="odd">
<td align="left">Other</td>
<td align="left">reserved for future use</td>
</tr>
</tbody>
</table>
<p>* Version 2 was never enabled in the encoder thus version 2 files SHOULD NOT exist, and this document does not describe them to keep the text simpler.</p>
<p><strong>micro_version</strong> specifies the micro-version of the bitstream.<br />After a version is considered stable (a micro-version value is assigned to be the first stable variant of a specific version), each new micro-version after this first stable variant is compatible with the previous micro-version: decoders SHOULD NOT reject a file due to an unknown micro-version equal or above the micro-version considered as stable.</p>
<p>Meaning of micro_version for version 3:</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">micro_version</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0...3</td>
<td align="left">reserved*</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">first stable variant</td>
</tr>
<tr class="odd">
<td align="left">Other</td>
<td align="left">reserved for future use</td>
</tr>
</tbody>
</table>
<p>* were development versions which may be incompatible with the stable variants.</p>
<p>Meaning of micro_version for version 4 (note: at the time of writting of this specification, version 4 is not considered stable so the first stable version value is to be annonced in the future):</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">micro_version</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0...TBA</td>
<td align="left">reserved*</td>
</tr>
<tr class="even">
<td align="left">TBA</td>
<td align="left">first stable variant</td>
</tr>
<tr class="odd">
<td align="left">Other</td>
<td align="left">reserved for future use</td>
</tr>
</tbody>
</table>
<p>* were development versions which may be incompatible with the stable variants.</p>
<p><strong>coder_type</strong> specifies the coder used</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">coder used</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">Golomb Rice</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">Range Coder with default state transition table</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Range Coder with custom state transition table</td>
</tr>
<tr class="even">
<td align="left">Other</td>
<td align="left">reserved for future use</td>
</tr>
</tbody>
</table>
<p><strong>state_transition_delta</strong> specifies the range coder custom state transition table.<br />If state_transition_delta is not present in the bitstream, all range coder custom state transition table elements are assumed to be 0.</p>
<p><strong>colorspace_type</strong> specifies the color space.</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">color space used</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">YCbCr</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">JPEG 2000 RCT</td>
</tr>
<tr class="odd">
<td align="left">Other</td>
<td align="left">reserved for future use</td>
</tr>
</tbody>
</table>
<p><strong>chroma_planes</strong> indicates if chroma (color) planes are present.</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">color space used</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">chroma planes are not present</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">chroma planes are present</td>
</tr>
</tbody>
</table>
<p><strong>bits_per_raw_sample</strong> indicates the number of bits for each luma and chroma sample. Inferred to be 8 if not present.</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">bits for each luma and chroma sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">reserved*</td>
</tr>
<tr class="even">
<td align="left">Other</td>
<td align="left">the actual bits for each luma and chroma sample</td>
</tr>
</tbody>
</table>
<p>* Encoders MUST not store bits_per_raw_sample = 0<br />Decoders SHOULD accept and interpret bits_per_raw_sample = 0 as 8.</p>
<p><strong>h_chroma_subsample</strong> indicates the subsample factor between luma and chroma width (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>h</mi><mi>r</mi><mi>o</mi><mi>m</mi><mi>a</mi><mo accent="false">_</mo><mi>w</mi><mi>i</mi><mi>d</mi><mi>t</mi><mi>h</mi><mo>=</mo><msup><mn>2</mn><mrow><mo>−</mo><mi>l</mi><mi>o</mi><mi>g</mi><mn>2</mn><mo accent="false">_</mo><mi>h</mi><mo accent="false">_</mo><mi>c</mi><mi>h</mi><mi>r</mi><mi>o</mi><mi>m</mi><mi>a</mi><mo accent="false">_</mo><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi></mrow></msup><mi>l</mi><mi>u</mi><mi>m</mi><mi>a</mi><mo accent="false">_</mo><mi>w</mi><mi>i</mi><mi>d</mi><mi>t</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">chroma\_width=2^{-log2\_h\_chroma\_subsample}luma\_width</annotation></semantics></math>)</p>
<p><strong>v_chroma_subsample</strong> indicates the subsample factor between luma and chroma height (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>h</mi><mi>r</mi><mi>o</mi><mi>m</mi><mi>a</mi><mo accent="false">_</mo><mi>h</mi><mi>e</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mo>=</mo><msup><mn>2</mn><mrow><mo>−</mo><mi>l</mi><mi>o</mi><mi>g</mi><mn>2</mn><mo accent="false">_</mo><mi>v</mi><mo accent="false">_</mo><mi>c</mi><mi>h</mi><mi>r</mi><mi>o</mi><mi>m</mi><mi>a</mi><mo accent="false">_</mo><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi></mrow></msup><mi>l</mi><mi>u</mi><mi>m</mi><mi>a</mi><mo accent="false">_</mo><mi>h</mi><mi>e</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">chroma\_height=2^{-log2\_v\_chroma\_subsample}luma\_height</annotation></semantics></math>)</p>
<dl>
<dt><strong>alpha_plane</strong></dt>
<dd>indicates if a transparency plane is present.
</dd>
</dl>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">color space used</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">transparency plane is not present</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">transparency plane is present</td>
</tr>
</tbody>
</table>
<p><strong>num_h_slices</strong> indicates the number of horizontal elements of the slice raster.<br /> Inferred to be 1 if not present.</p>
<p><strong>num_v_slices</strong> indicates the number of vertical elements of the slice raster.<br /> Inferred to be 1 if not present.</p>
<p><strong>quant_table_count</strong> indicates the number of quantization table sets.<br /> Inferred to be 1 if not present.</p>
<p><strong>states_coded</strong> indicates if the respective quantization table set has the initial states coded.<br /> Inferred to be 0 if not present.</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">initial states</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">initial states are not present and are assumed to be all 128</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">initial states are present</td>
</tr>
</tbody>
</table>
<p><strong>initial_state_delta</strong> [ i ][ j ][ k ] indicates the initial range coder state, it is encoded using k as context index and<br /> pred = j ? initial_states[ i ][j - 1][ k ] : 128<br /> initial_state[ i ][ j ][ k ] = ( pred + initial_state_delta[ i ][ j ][ k ] ) &amp; 255</p>
<p><strong>slice_count</strong> indicates the number of slices in the current frame, slice_count is 1 if it is not explicitly coded.</p>
<p><strong>ec</strong> indicates the error detection/correction type.</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">error detection/correction type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">32bit CRC on the global header</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">32bit CRC per slice and the global header</td>
</tr>
<tr class="odd">
<td align="left">Other</td>
<td align="left">reserved for future use</td>
</tr>
</tbody>
</table>
<p><strong>intra</strong> indicates the relationship between frames. Inferred to be 0 if not present.</p>
<table>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="left">relationship</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">frames are independent or dependent (key and non key frames)</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">frames are independent (key frames only)</td>
</tr>
<tr class="odd">
<td align="left">Other</td>
<td align="left">reserved for future use</td>
</tr>
</tbody>
</table>
<h2 id="quantization-tables"><span class="header-section-number">5.6</span> Quantization Tables</h2>
<p>The quantization tables are stored by storing the number of equal entries -1 of the first half of the table using the method described in <a href="#range-non-binary-values">Range Non Binary Values</a>. The second half doesn’t need to be stored as it is identical to the first with flipped sign.</p>
<p>example:<br />Table: 0 0 1 1 1 1 2 2-2-2-2-1-1-1-1 0<br />Stored values: 1, 3, 1</p>
<table>
<thead>
<tr class="header">
<th align="left">QuantizationTable( i ) {</th>
<th align="left">type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">   scale = 1</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">    for( j = 0; j &lt; MAX_CONTEXT_INPUTS; j++ ) {</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">        QuantizationTablePerContext( i, j, scale )</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">        scale *= 2 * len_count[ i ][ j ] - 1</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">    }</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">    context_count[ i ] = ( scale + 1 ) / 2</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">}</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>MAX_CONTEXT_INPUTS is 5.</p>
<table>
<thead>
<tr class="header">
<th align="left">QuantizationTablePerContext(i, j, scale) {</th>
<th align="left">type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">    v = 0</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">    for( k = 0; k &lt; 128; ) {</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">        len - 1</td>
<td align="left">sr</td>
</tr>
<tr class="even">
<td align="left">        for( a = 0; a &lt; len; a++ ) {</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">            quant_tables[ i ][ j ][ k ] = scale* v</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">            k++</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">        }</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">        v++</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">    }</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">    for( k = 1; k &lt; 128; k++ ) {</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">        quant_tables[ i ][ j ][ 256 - k ] = -quant_tables[ i ][ j ][ k ]</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">    }</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">    quant_tables[ i ][ j ][ 128 ] = -quant_tables[ i ][ j ][ 127 ]</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">    len_count[ i ][ j ] = v</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">}</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p><strong>quant_tables</strong> indicates the quantification table values.</p>
<p><strong>context_count</strong> indicates the count of contexts.</p>
<h3 id="restrictions"><span class="header-section-number">5.6.1</span> Restrictions</h3>
<p>In version 2 and later the maximum slice size in pixels is <span class="math">$\frac{width\centerdot height}{4}$</span>, this is to ensure that fast multithreaded decoding is possible.</p>
<h1 id="changelog"><span class="header-section-number">6</span> Changelog</h1>
<p>See <a href="https://github.com/FFmpeg/FFV1/commits/master" class="uri">https://github.com/FFmpeg/FFV1/commits/master</a></p>
<h1 id="todo"><span class="header-section-number">7</span> ToDo</h1>
<ul>
<li>mean,k estimation for the golomb rice codes</li>
</ul>
<h1 id="bibliography"><span class="header-section-number">8</span> Bibliography</h1>
<h2 id="references"><span class="header-section-number">8.1</span> References</h2>
<p>RFC 2119 - Key words for use in RFCs to Indicate Requirement Levels <a href="https://www.ietf.org/rfc/rfc2119.txt" class="uri">https://www.ietf.org/rfc/rfc2119.txt</a></p>
<p>ISO/IEC 9899 - Programming languages - C <a href="http://www.open-std.org/JTC1/SC22/WG14/www/standards" class="uri">http://www.open-std.org/JTC1/SC22/WG14/www/standards</a></p>
<p>JPEG-LS FCD 14495 <a href="http://www.jpeg.org/public/fcd14495p.pdf" class="uri">http://www.jpeg.org/public/fcd14495p.pdf</a></p>
<p>H.264 Draft <a href="http://bs.hhi.de/~wiegand/JVT-G050.pdf" class="uri">http://bs.hhi.de/~wiegand/JVT-G050.pdf</a></p>
<p>HuffYuv <a href="http://cultact-server.novi.dk/kpo/huffyuv/huffyuv.html" class="uri">http://cultact-server.novi.dk/kpo/huffyuv/huffyuv.html</a></p>
<p>FFmpeg <a href="http://ffmpeg.org" class="uri">http://ffmpeg.org</a></p>
<p>JPEG2000 <a href="http://www.jpeg.org/jpeg2000/" class="uri">http://www.jpeg.org/jpeg2000/</a></p>
<p>Range encoding: an algorithm for removing redundancy from a digitised message. Presented by G. Nigel N. Martin at the Video &amp; Data Recording Conference, IBM UK Scientific Center held in Southampton July 24-27 1979.</p>
<p>AVI RIFF File Format <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd318189%28v=vs.85%29.aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/dd318189%28v=vs.85%29.aspx</a></p>
<p>Information technology Coding of audio-visual objects Part 12: ISO base media file format <a href="http://www.iso.org/iso/iso_catalogue/catalogue_tc/catalogue_detail.htm?csnumber=61988" class="uri">http://www.iso.org/iso/iso_catalogue/catalogue_tc/catalogue_detail.htm?csnumber=61988</a></p>
<p>NUT Open Container Format <a href="http://www.ffmpeg.org/~michael/nut.txt" class="uri">http://www.ffmpeg.org/~michael/nut.txt</a></p>
<h1 id="copyright"><span class="header-section-number">9</span> Copyright</h1>
<p>Copyright 2003-2013 Michael Niedermayer &lt;michaelni@gmx.at&gt;<br />This text can be used under the GNU Free Documentation License or GNU General Public License. See <a href="http://www.gnu.org/licenses/fdl.txt" class="uri">http://www.gnu.org/licenses/fdl.txt</a>.</p>
</body>
</html>
